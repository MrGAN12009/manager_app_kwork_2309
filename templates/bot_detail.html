{% extends 'base.html' %}
{% block title %}Бот {{ bot.name }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>{{ bot.name }}</h3>
  <div>
    {% if has_endpoint('edit_bot') %}
    <a class="btn btn-outline-light" href="{{ url_for('edit_bot', bot_id=bot.id) }}">Редактировать</a>
    {% else %}
    <a class="btn btn-outline-light" href="{{ url_for('dashboard') }}">К списку</a>
    {% endif %}
  </div>
</div>
<div class="row g-3">
  <div class="col-md-8">
    <div class="card p-3">
      <div>Статус: <span class="badge bg-{{ 'success' if runtime_status=='running' else 'secondary' }}">{{ runtime_status }}</span></div>
      <div class="mt-2">Репозиторий: {{ bot.repo_url }} ({{ bot.branch }})</div>
      <div class="mt-2">Рабочая папка: <code>{{ bot.workdir }}</code></div>
      <div class="mt-2">Последний коммит: <code>{{ bot.last_commit or '-' }}</code></div>
      <div class="mt-3">
        <form class="d-inline" method="post" action="{% if has_endpoint('start_bot') %}{{ url_for('start_bot', bot_id=bot.id) }}{% else %}#{% endif %}">
          <button class="btn btn-success">Старт</button>
        </form>
        <form class="d-inline" method="post" action="{% if has_endpoint('stop_bot') %}{{ url_for('stop_bot', bot_id=bot.id) }}{% else %}#{% endif %}">
          <button class="btn btn-danger">Стоп</button>
        </form>
        <form class="d-inline" method="post" action="{% if has_endpoint('restart_bot') %}{{ url_for('restart_bot', bot_id=bot.id) }}{% else %}#{% endif %}">
          <button class="btn btn-warning">Перезапуск</button>
        </form>
        <form class="d-inline" method="post" action="{% if has_endpoint('update_repo') %}{{ url_for('update_repo', bot_id=bot.id) }}{% else %}#{% endif %}">
          <button class="btn btn-outline-primary">Обновить из Git</button>
        </form>
        <a class="btn btn-outline-info" href="{% if has_endpoint('view_logs') %}{{ url_for('view_logs', bot_id=bot.id) }}{% else %}#{% endif %}">Логи</a>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3">
      <h5>Статистика</h5>
      <form class="mb-2" method="get" action="{{ url_for('bot_detail', bot_id=bot.id) }}">
        <div class="btn-group mb-2" role="group">
          <a class="btn btn-sm btn-{{ 'secondary' if computed_stats and computed_stats.period!='day' else 'primary' }}" href="{{ url_for('bot_detail', bot_id=bot.id, period='day') }}">День</a>
          <a class="btn btn-sm btn-{{ 'secondary' if computed_stats and computed_stats.period!='week' else 'primary' }}" href="{{ url_for('bot_detail', bot_id=bot.id, period='week') }}">Неделя</a>
          <a class="btn btn-sm btn-{{ 'secondary' if computed_stats and computed_stats.period!='month' else 'primary' }}" href="{{ url_for('bot_detail', bot_id=bot.id, period='month') }}">Месяц</a>
          <a class="btn btn-sm btn-{{ 'secondary' if computed_stats and computed_stats.period!='all' else 'primary' }}" href="{{ url_for('bot_detail', bot_id=bot.id, period='all') }}">Всё</a>
        </div>
        <div class="row g-2 align-items-end">
          <div class="col-6">
            <label class="form-label small">C</label>
            <input type="datetime-local" class="form-control form-control-sm" name="start" value="{{ computed_stats.start if computed_stats else ''|replace(' ', 'T') }}">
          </div>
          <div class="col-6">
            <label class="form-label small">По</label>
            <input type="datetime-local" class="form-control form-control-sm" name="end" value="{{ computed_stats.end if computed_stats else ''|replace(' ', 'T') }}">
          </div>
          <div class="col-12 mt-2">
            <button class="btn btn-sm btn-outline-light">Применить</button>
          </div>
        </div>
      </form>
      <div>Сообщений: {{ (computed_stats.messages if computed_stats else (bot.stats.messages_count if bot.stats else 0)) }}</div>
      <div>Уникальные пользователи: {{ (computed_stats.users if computed_stats else (bot.stats.users_count if bot.stats else 0)) }}</div>
      <div>Среднее сообщений/польз.: {{ '%.2f' % (computed_stats.avg_per_user or 0) }}</div>
      <div>DAU (24ч): {{ computed_stats.dau or 0 }}</div>
      <div>WAU (7д): {{ computed_stats.wau or 0 }}</div>
      <div>Последняя активность: {{ (computed_stats.last_activity if computed_stats else (bot.stats.last_activity_at if bot.stats else None)) or '-' }}</div>
    </div>
  </div>
</div>
<div class="row mt-3">
  <div class="col-12">
    <div class="card p-3">
      <h6 class="mb-3">Динамика сообщений ({{ computed_stats.chart_granularity == 'daily' and 'по дням' or 'по неделям' }})</h6>
      <canvas id="msgsChart" height="120"></canvas>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const labels = {{ (computed_stats.chart_labels or [])|tojson }};
    const values = {{ (computed_stats.chart_values or [])|tojson }};
    const ctx = document.getElementById('msgsChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Сообщений',
          data: values,
          tension: 0.25,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.15)',
          fill: true,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 12 } },
          y: { beginAtZero: true, precision: 0 }
        },
        plugins: { legend: { display: false } }
      }
    });
  })();
</script>
{% endblock %}
