{% extends 'base.html' %}
{% block title %}Установка {{ bot.name }}{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card p-4">
      <h3 class="mb-3">Подготовка бота: {{ bot.name }}</h3>
      <div id="progress-text" class="mb-2">Шаг {{ bot.setup_step }} из {{ bot.setup_total }} — {{ bot.setup_message }}</div>
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
      </div>
      <div class="mt-3" id="final-actions" style="display:none;">
        <a class="btn btn-success" href="{{ url_for('bot_detail', bot_id=bot.id) }}">Перейти к боту</a>
      </div>
    </div>
  </div>
</div>
<script>
function refreshStatus(){
  fetch("{{ url_for('api_setup_status', bot_id=bot.id) }}").then(r=>r.json()).then(d=>{
    if(d.error){ return; }
    const pct = Math.min(100, Math.round((d.step / Math.max(1,d.total)) * 100));
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-text').textContent = `Шаг ${d.step} из ${d.total} — ${d.message}`;
    if(d.status === 'done' || d.status === 'failed'){
      document.getElementById('final-actions').style.display = 'block';
    } else {
      setTimeout(refreshStatus, 1500);
    }
  }).catch(()=>{ setTimeout(refreshStatus, 2000); });
}
refreshStatus();
</script>
{% endblock %}
